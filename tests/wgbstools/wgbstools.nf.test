nextflow_pipeline {

    name "Test Workflow main.nf"
    script "main.nf"

    test("DMRselection: wgbstools") {

        when {
            params {
                outdir = "$outputDir"
                DMRselection = "wgbstools"
                save_intermeds = true
                benchmark = true
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert new File( "$outputDir/wgbstools/atlas/Atlas.l3.tsv" ).exists()},
                { assert new File( "$outputDir/refree_preprocessing/ref_free_matrix.csv" ).exists()},
                { assert new File( "$outputDir/test_preprocessing/test_matrix.csv" ).exists()},
                { assert new File( "$outputDir/celfie/celfie_matrix.txt" ).exists()},
                { assert new File( "$outputDir/epidish/epidish_res_RPC.csv" ).exists()},
                { assert new File( "$outputDir/cibersort/test_samples_deconv_output.csv" ).exists()},
                { assert new File( "$outputDir/episcore/test_samples_deconv_output_weight_0.4.csv" ).exists()},
                { assert new File( "$outputDir/metdecode/output.csv" ).exists()},
                { assert new File( "$outputDir/methyl_resolver/test_samples_deconv_output_alpha_0.5.csv" ).exists()},
                { assert new File( "$outputDir/methyl_atlas/test_matrix_deconv_output.csv" ).exists()},
                { assert new File( "$outputDir/uxm/results/output.csv" ).exists()},
                { assert new File( "$outputDir/prmeth/test_samples_deconv_output_mod_QP.csv" ).exists()},

                { assert snapshot(
                    path("$outputDir/wgbstools/atlas/Atlas.l3.tsv"),
                    path("$outputDir/refree_preprocessing/ref_free_matrix.csv"),
                    path("$outputDir/test_preprocessing/test_matrix.csv"),
                    path("$outputDir/celfie/celfie_matrix.txt"),
                    path("$outputDir/epidish/epidish_res_RPC.csv"),
                    path("$outputDir/cibersort/test_samples_deconv_output.csv"),
                    path("$outputDir/episcore/test_samples_deconv_output_weight_0.4.csv"),
                    path("$outputDir/metdecode/output.csv"),
                    path("$outputDir/methyl_resolver/test_samples_deconv_output_alpha_0.5.csv"),                
                    path("$outputDir/methyl_atlas/test_matrix_deconv_output.csv"),
                    path("$outputDir/uxm/results/output.csv"),
                    path("$outputDir/prmeth/test_samples_deconv_output_mod_QP.csv")).match() }
            )
        }
    }
}