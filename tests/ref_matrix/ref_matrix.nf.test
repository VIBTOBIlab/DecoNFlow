nextflow_pipeline {

    name "Test Workflow main.nf"
    script "main.nf"

    test("DMRselection: none (ref_matrix)") {

        when {
            params {
                outdir = "$outputDir"
                ref_matrix = "${projectDir}/assets/reference_matrix_1_BH_mean.tsv"
                DMRselection = null
                input = null
                ref_bams = null
                test_bams = null
                save_intermeds = true
                benchmark = false
                epidish = true
                cibersort = true
                episcore = true
                methyl_atlas = true
                methyl_resolver = true
                prmeth = true
                prmeth_rf = true
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert new File( "$outputDir/refree_preprocessing/ref_free_matrix.csv" ).exists()},
                { assert new File( "$outputDir/test_preprocessing/test_matrix.csv" ).exists()},
                { assert new File( "$outputDir/epidish/epidish_res_RPC.csv" ).exists()},
                { assert new File( "$outputDir/cibersort/test_samples_deconv_output.csv" ).exists()},
                { assert new File( "$outputDir/episcore/test_samples_deconv_output_weight_0.4.csv" ).exists()},
                { assert new File( "$outputDir/methyl_resolver/test_samples_deconv_output_alpha_0.5.csv" ).exists()},
                { assert new File( "$outputDir/methyl_atlas/test_matrix_deconv_output.csv" ).exists()},
                { assert new File( "$outputDir/prmeth/test_samples_deconv_output_mod_QP.csv" ).exists()},

                { assert snapshot(
                    path("$outputDir/refree_preprocessing/ref_free_matrix.csv"),
                    path("$outputDir/test_preprocessing/test_matrix.csv"),
                    path("$outputDir/epidish/epidish_res_RPC.csv"),
                    path("$outputDir/cibersort/test_samples_deconv_output.csv"),
                    path("$outputDir/episcore/test_samples_deconv_output_weight_0.4.csv"),
                    path("$outputDir/methyl_resolver/test_samples_deconv_output_alpha_0.5.csv"),                
                    path("$outputDir/methyl_atlas/test_matrix_deconv_output.csv"),
                    path("$outputDir/prmeth/test_samples_deconv_output_mod_QP.csv")).match() }
            )
        }
    }
}